<!DOCTYPE html>
<html>
 <head>
  <meta charset="UTF-8">
  <title>\o/ Chat</title>
  <style>
	#chats {
		list-style-type: none;
		border: 1px solid black;
	}
  </style>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
  <script type="text/javascript">
	$(document).ready(function(){

		var lastChat = -1;

		function getChats()
		{
                        $.ajax({
                                url: "chat.php",
                                type: "GET",
				data: {
					lastChat: lastChat
				},
                                dataType: "json",
                                success: function(data){

					if(lastChat == -1)
	                                        $("#chats").html("");

                                        for(var ct=0; ct < data.length; ct++)
                                        {
                                                //Can access data[ct].id .user .message .sent
                                                var aMessage = "<li><strong>" + data[ct].user +  "</strong>: " + data[ct].message + " - <em>" + data[ct].sent  + "</em></li>";
                                                $("#chats").append(aMessage);
						
						if(parseInt(data[ct].id) > lastChat)
						{
							lastChat = parseInt(data[ct].id);
						}
                                        }
                                },
				complete: function()
				{
					getChats();
				}

                        });
                }

		getChats();

		$("#login").click(function(){
               		 var username=$("#username").val();
               	 	var password=$("#password").val();
        	$.ajax({
                	url:"login.php",
               		type:"POST",
                	data:{username:username, password:password},

               		 success:function(data){
                        	$("#loginForm").toggle();
                	}

        		});
		 });

		$("#logout").click(function() {
			$.ajax({
				url: "logout.php",
				type: "GET"
			});
		});

		$("#sendChat").click(function(){
			var message = $("#chatMessage").val();

			$.ajax({
				url: "chat.php",
				type: "POST",
				data: {
					message : message
				},
				error: function(xhr){
                                 if(xhr.status == 401)
                                  {
		    			console.log(xhr);
					$("#loginForm").toggle();
                                       
                                  }
				}
			});
		});		


	});
  </script>
 </head>
 <body>	
	<h1>\o/ Chat</h1>
	<div>
		<button id="logout">Logout</button>
	</div>
	<div id="loginForm" style="display: none;">
		<label>
			User: <input id="username" type="text" />
		</label>
		<label>
			Pass: <input id="password" type="text" />
		</label>
		<button id="login">Login</button>
	</div>

	<div>
		<ul id="chats">
			<li><strong>User</strong>: Message - <em>Date</em></li>
		</ul>
	</div>	

	<div>
		<label> 
			Chat: <textarea id="chatMessage"></textarea>
		</label>
		<button id="sendChat">Send</button>
	</div>

 </body>
</html>

